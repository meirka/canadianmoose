name: Notify Telegram on new Topic

on:
  discussion_comment:
    types: [created]
  workflow_dispatch: {}   # optional: lets you test manually

permissions:
  discussions: read
  contents: read

jobs:
  send:
    runs-on: ubuntu-latest
    timeout-minutes: 3
    steps:
      - uses: actions/github-script@v7
        env:
          TG_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TG_CHAT:  ${{ secrets.TELEGRAM_CHAT_ID }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // github, context, core, fetch are provided by github-script (Node 20).

            // ---------- helper: escape for Telegram MarkdownV2 ----------
            const tgEscape = (str = '') =>
              str.replace(/[_*[\]()~`>#+\-=|{}.!]/g, ch => '\\' + ch);

            // ---------- early-exit guards ----------
            if (context.eventName === 'workflow_dispatch') {
              core.info('Manual run - nothing to do.'); return;
            }
            if (context.payload.action !== 'created') {
              core.info('Not a create action; skipping.'); return;
            }

            const discussionNumber = context.payload.discussion?.number;
            const commentUrl = context.payload.comment?.html_url;
            const commentNodeId = context.payload.comment?.node_id;

            if (!discussionNumber || !commentUrl || !commentNodeId) {
              core.info('Missing discussion/comment info (need number, html_url, node_id); skipping.');
              return;
            }

            // ---------- GraphQL: get discussion + comment ----------
            const q = `
              query ($owner:String!, $repo:String!, $number:Int!, $commentId:ID!) {
                repository(owner:$owner, name:$repo) {
                  discussion(number:$number) {
                    title
                    url
                    category { name }
                  }
                }
                node(id:$commentId) {
                  __typename
                  ... on DiscussionComment {
                    id
                    body
                    createdAt
                    author { login }
                    replyTo { id }
                  }
                }
              }`;

            const vars = {
              owner: context.repo.owner,
              repo:  context.repo.repo,
              number: discussionNumber,
              commentId: commentNodeId
            };

            const data = await github.graphql(q, vars);
            const disc = data?.repository?.discussion;
            const c    = data?.node;

            if (!disc || c?.__typename !== 'DiscussionComment') {
              core.info('Not a discussion comment; skipping.'); return;
            }

            // ---------- only top-level comments in ‚ÄúTopics‚Äù ----------
            const isTopics   = (disc.category?.name || '').toLowerCase() === 'topics';
            const isTopLevel = !(c.replyTo && c.replyTo.id);
            if (!isTopics || !isTopLevel) {
              core.info('Not a top-level comment in Topics; skipping.'); return;
            }

            // ---------- build human-readable message ----------
            const body  = c.body || '';
            const lines = body.split('\n').map(s => s.trim()).filter(Boolean);
            const firstLine = lines[0] || '(no title)';
            const rest      = lines.slice(1).join(' ');
            const excerpt   = rest.length > 240 ? rest.slice(0, 237) + '‚Ä¶' : rest;

            const author = c.author?.login ? '@' + c.author.login : 'Someone';

            const rawText = [
              '–î–æ–±–∞–≤–ª–µ–Ω–∞ –Ω–æ–≤–∞—è —Ç–µ–º–∞ –¥–ª—è –æ–±—Å—É–∂–¥–µ–Ω–∏—è',
              firstLine,
              excerpt ? ('üìù ' + excerpt) : null,
              '\n–°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Ç–µ–º –∑–¥–µ—Å—å: https://rcmp.cloud/topics/'
            ].filter(Boolean).join('\n');

            // ---------- escape for Telegram MarkdownV2 ----------
            const safeText = tgEscape(rawText);

            // ---------- send ----------
            const resp = await fetch(`https://api.telegram.org/bot${process.env.TG_TOKEN}/sendMessage`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                chat_id: process.env.TG_CHAT,
                text: safeText,
                parseMode: 'MarkdownV2',
                webPreview: true
              })
            });

            if (!resp.ok) {
              const errTxt = await resp.text();
              core.setFailed('Telegram send failed: ' + resp.status + ' ' + errTxt);
              return;
            }
            core.info('Sent to Telegram ‚úÖ');
